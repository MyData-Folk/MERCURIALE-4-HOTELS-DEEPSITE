<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>MERCURIO – Comparateur & Commande</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            min-height: 100vh;
        }

        .gradient-text-header {
            color: white;
        }

        /* Styles des boutons */
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #2563eb);
            transition: all 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            transition: all 0.2s;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        /* Style de la barre de défilement personnalisée */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7d2fe;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a5b4fc;
        }

        /* Surlignage pour le terme recherché */
        .search-highlight {
            background-color: #e0e7ff;
            padding: 0 2px;
            border-radius: 2px;
            font-weight: 600;
        }
        
        /* Animation pour le bouton Ajouter tout */
        @keyframes pulse-gentle {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .btn-primary:hover {
            animation: pulse-gentle 2s infinite;
        }

        /* Style pour les boutons désactivés */
        .btn-disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
        }

        /* Style pour le statut "Déjà ajouté" */
        .status-added {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        /* Style pour le bouton Nouvelle Commande */
        .btn-reset {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            transition: all 0.2s;
        }
        
        .btn-reset:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        /* Mode sélection */
        .mode-selector {
            display: flex;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mode-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #e0e7ff;
            color: #4f46e5;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #4f46e5, #2563eb);
            color: white;
        }

        .mode-btn:first-child {
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        .mode-btn:last-child {
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        /* Comparaison de prix */
        .price-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .price-card {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .price-card-header {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 0.5rem;
        }

        .price-card-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen flex flex-col items-center justify-center py-8 px-4">
        <div class="w-full max-w-7xl bg-white rounded-xl shadow-xl">
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 p-6 text-white rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center">
                            <i class="fas fa-store-alt mr-3"></i>
                            <span class="gradient-text-header">MERCURIO</span>
                        </h1>
                        <p class="text-blue-100 mt-1">Comparez vos mercuriales, préparez et exportez votre commande fournisseur</p>
                    </div>
                    <div class="hidden md:block">
                        <div class="flex space-x-2">
                            <span class="bg-blue-500 text-xs px-3 py-1 rounded-full flex items-center"><i class="fas fa-database mr-1"></i><span>4 sources</span></span>
                            <span class="bg-blue-500 text-xs px-3 py-1 rounded-full flex items-center"><i class="fas fa-boxes mr-1"></i><span id="productCount">0 produits</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="p-6">
                <!-- Mode Selector -->
                <div class="mode-selector">
                    <div class="mode-btn active" data-mode="compare">
                        <i class="fas fa-chart-line mr-2"></i>Comparer les prix
                    </div>
                    <div class="mode-btn" data-mode="order">
                        <i class="fas fa-shopping-cart mr-2"></i>Préparer commande
                    </div>
                </div>

                <!-- Compare Mode -->
                <div id="compareMode">
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-search mr-2 text-indigo-500"></i>Rechercher un produit
                        </h2>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-barcode text-gray-400"></i>
                            </div>
                            <input type="text" id="productCodeInput" placeholder="Entrez un code produit (ex: 12345)..." autocomplete="off" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- Price Comparison Results -->
                    <div id="priceComparisonResults" class="hidden">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-balance-scale mr-2 text-indigo-500"></i>Comparaison des prix
                        </h2>
                        <div id="priceComparisonCards" class="price-comparison"></div>
                        
                        <div class="mt-6">
                            <button id="addToComparisonListBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
                                <i class="fas fa-plus-circle mr-2"></i>Ajouter à la liste de comparaison
                            </button>
                        </div>
                    </div>

                    <!-- Comparison List -->
                    <div id="comparisonListSection" class="mt-8 hidden">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-list-ul mr-2 text-indigo-500"></i>Liste de comparaison
                                <span id="comparisonCount" class="ml-2 bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span>
                            </h2>
                            <div class="flex space-x-2">
                                <button id="exportComparisonCsvBtn" class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
                                    <i class="fas fa-file-csv mr-2"></i>CSV
                                </button>
                                <button id="exportComparisonXlsxBtn" class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
                                    <i class="fas fa-file-excel mr-2"></i>Excel
                                </button>
                            </div>
                        </div>
                        <div id="comparisonList" class="border border-gray-200 rounded-lg">
                            <p class="text-center text-gray-500 py-8 px-4">Aucun article ajouté à la liste de comparaison.</p>
                        </div>
                    </div>
                </div>

                <!-- Order Mode -->
                <div id="orderMode" class="hidden">
                    <!-- Search & Filter Section -->
                    <div class="mb-8">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                            <div class="flex flex-wrap gap-3">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="source" value="folkestone" checked class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"><span class="ml-2 text-gray-700 font-medium">Folkestone</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="source" value="vendome" checked class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"><span class="ml-2 text-gray-700 font-medium">Vendôme</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="source" value="washington" checked class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"><span class="ml-2 text-gray-700 font-medium">Washington</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="source" value="lehavre" checked class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                                    <span class="ml-2 text-gray-700 font-medium">Le Havre</span>
                                </label>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="relative">
                                    <button id="columnSelectorBtn" class="w-full sm:w-auto flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        <i class="fas fa-columns mr-2"></i>
                                        Afficher les colonnes
                                        <i class="fas fa-chevron-down ml-2 -mr-1 h-5 w-5"></i>
                                    </button>
                                    <div id="columnSelectorDropdown" class="hidden origin-top-right absolute right-0 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-20">
                                        <div class="p-2" id="columnCheckboxes">
                                            <p class="text-sm text-gray-500 text-center py-2">Chargement...</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="relative w-full sm:w-auto">
                                    <select id="searchField" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 pl-3 pr-10 text-base bg-gray-50">
                                        <option value="all" selected>Tous les champs</option>
                                        <option value="Libellé produit">Libellé produit</option>
                                        <option value="Marque">Marque</option>
                                        <option value="Code Produit">Code Produit</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="searchInput" placeholder="Rechercher un produit, ou plusieurs codes produits séparés par un espace..." autocomplete="off" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-search mr-2 text-indigo-500"></i>Résultats de recherche</h2>
                        <div id="searchResults" class="border border-gray-200 rounded-lg">
                            <p class="text-center text-gray-500 py-8 px-4">Commencez à taper pour rechercher...</p>
                        </div>
                    </div>

                    <!-- Order Section -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-semibold text-gray-800 flex items-center"><i class="fas fa-shopping-cart mr-2 text-indigo-500"></i>Ma commande<span id="orderCount" class="ml-2 bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span></h2>
                            <div class="flex space-x-2">
                                <button id="newOrderBtn" class="btn-reset text-white px-4 py-2 rounded-md text-sm font-medium flex items-center"><i class="fas fa-trash-alt mr-2"></i>Nouvelle Commande</button>
                                <button id="downloadCsvBtn" disabled class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-file-csv mr-2"></i>CSV</button>
                                <button id="downloadXlsxBtn" disabled class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-file-excel mr-2"></i>Excel</button>
                            </div>
                        </div>
                        <div id="orderList" class="border border-gray-200 rounded-lg">
                            <p class="text-center text-gray-500 py-8 px-4">Aucun article ajouté.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 rounded-b-xl">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between text-sm text-gray-500">
                    <div class="flex items-center justify-center md:justify-start mb-2 md:mb-0"><i class="fas fa-info-circle mr-2"></i><span>© 2025 MERCURIO – MyData-Folk</span></div>
                    <div class="flex items-center justify-center md:justify-end space-x-4">
                        <a href="CONVERTISSEUR/index.html" target="_blank" class="hover:text-indigo-600"><i class="fas fa-sync-alt mr-1"></i>Convertisseur JSON</a>
                        <a href="#" id="settingsBtn" class="hover:text-indigo-600"><i class="fas fa-cog mr-1"></i>Paramètres</a>
                        <a href="#" id="contactBtn" class="hover:text-indigo-600"><i class="fas fa-envelope mr-1"></i>Contact</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOUVEAU: Modale Paramètres -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold">Paramètres</p>
                <div class="cursor-pointer z-50 modal-close">
                    <i class="fas fa-times text-gray-500"></i>
                </div>
            </div>
            <div class="text-sm">
                <p class="mb-4">Gérez les préférences de votre application ici.</p>
                <button id="resetAppBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-trash-alt mr-2"></i>Réinitialiser la commande et les préférences
                </button>
                 <p class="text-xs text-gray-500 mt-2">Attention : Cette action est irréversible. Elle videra votre commande en cours et réinitialisera l'affichage des colonnes par défaut.</p>
            </div>
        </div>
    </div>

    <!-- NOUVEAU: Modale Contact -->
    <div id="contactModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold">Contact</p>
                <div class="cursor-pointer z-50 modal-close">
                    <i class="fas fa-times text-gray-500"></i>
                </div>
            </div>
            <div class="text-sm">
                <p class="mb-4">Pour toute question ou assistance, veuillez nous contacter à l'adresse suivante :</p>
                <div class="text-center p-3 bg-gray-100 rounded-md">
                    <a href="mailto:mydata.folkestone@gmail.com" class="text-indigo-600 font-semibold hover:underline">
                        <i class="fas fa-envelope mr-2"></i>mydata.folkestone@gmail.com
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const modeBtns = document.querySelectorAll('.mode-btn');
            const compareMode = document.getElementById('compareMode');
            const orderMode = document.getElementById('orderMode');
            const productCodeInput = document.getElementById('productCodeInput');
            const priceComparisonResults = document.getElementById('priceComparisonResults');
            const priceComparisonCards = document.getElementById('priceComparisonCards');
            const addToComparisonListBtn = document.getElementById('addToComparisonListBtn');
            const comparisonListSection = document.getElementById('comparisonListSection');
            const comparisonList = document.getElementById('comparisonList');
            const comparisonCount = document.getElementById('comparisonCount');
            const exportComparisonCsvBtn = document.getElementById('exportComparisonCsvBtn');
            const exportComparisonXlsxBtn = document.getElementById('exportComparisonXlsxBtn');
            
            // Existing DOM elements (from order mode)
            const searchInput = document.getElementById('searchInput');
            const searchField = document.getElementById('searchField');
            const sourceCheckboxes = document.querySelectorAll('input[name="source"]');
            const searchResultsContainer = document.getElementById('searchResults');
            const orderListContainer = document.getElementById('orderList');
            const downloadCsvBtn = document.getElementById('downloadCsvBtn');
            const downloadXlsxBtn = document.getElementById('downloadXlsxBtn');
            const orderCountElement = document.getElementById('orderCount');
            const productCountElement = document.getElementById('productCount');
            const columnSelectorBtn = document.getElementById('columnSelectorBtn');
            const columnSelectorDropdown = document.getElementById('columnSelectorDropdown');
            const columnCheckboxesContainer = document.getElementById('columnCheckboxes');
            const newOrderBtn = document.getElementById('newOrderBtn');
            
            // Modal Elements
            const settingsBtn = document.getElementById('settingsBtn');
            const contactBtn = document.getElementById('contactBtn');
            const settingsModal = document.getElementById('settingsModal');
            const contactModal = document.getElementById('contactModal');
            const closeModalBtns = document.querySelectorAll('.modal-close');
            const resetAppBtn = document.getElementById('resetAppBtn');

            // State
            let dataFolkestone = [], dataVendome = [], dataWashington = [], dataLeHavre = [];
            let currentData = [], orderList = [], lastSearchResults = [];
            let allHeaders = [], visibleColumns = [];
            let comparisonListData = [];
            let currentProductCode = null;
            let currentProductDetails = null;

            // --- LOCALSTORAGE ---
            function loadStateFromLocalStorage() {
                const savedOrder = localStorage.getItem('mercurialeOrder');
                const savedColumns = localStorage.getItem('mercurialeColumns');
                const savedComparison = localStorage.getItem('mercurialeComparison');
                
                orderList = savedOrder ? JSON.parse(savedOrder) : [];
                visibleColumns = savedColumns ? JSON.parse(savedColumns) : ['Libellé produit', 'Marque', 'Prix'];
                comparisonListData = savedComparison ? JSON.parse(savedComparison) : [];
            }
            
            function saveOrderToLocalStorage() {
                localStorage.setItem('mercurialeOrder', JSON.stringify(orderList));
            }

            function saveColumnsToLocalStorage() {
                localStorage.setItem('mercurialeColumns', JSON.stringify(visibleColumns));
            }
            
            function saveComparisonToLocalStorage() {
                localStorage.setItem('mercurialeComparison', JSON.stringify(comparisonListData));
            }
            
            // --- MODE SWITCHING ---
            modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    modeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const mode = btn.dataset.mode;
                    if (mode === 'compare') {
                        compareMode.classList.remove('hidden');
                        orderMode.classList.add('hidden');
                    } else {
                        compareMode.classList.add('hidden');
                        orderMode.classList.remove('hidden');
                    }
                });
            });

            // --- INITIALISATION ---
            loadStateFromLocalStorage();
            initializeModals();

            Promise.all([
                fetch('data/mercuriale-folkestone.json').then(r => r.json()),
                fetch('data/mercuriale-vendome.json').then(r => r.json()),
                fetch('data/mercuriale-washington.json').then(r => r.json()),
                fetch('data/mercuriale-lehavre.json').then(r => r.json())
            ])
            .then(([folkestone, vendome, washington, lehavre]) => {
                dataFolkestone = folkestone.map(x => ({...x, _source: 'Folkestone'}));
                dataVendome = vendome.map(x => ({...x, _source: 'Vendôme'}));
                dataWashington = washington.map(x => ({...x, _source: 'Washington'}));
                dataLeHavre = lehavre.map(x => ({...x, _source: 'Le Havre'}));
                
                if (dataFolkestone.length > 0) {
                    allHeaders = Object.keys(dataFolkestone[0]).filter(h => h !== '_source');
                    populateColumnSelector();
                }
                
                updateCurrentData();
                updateProductCount();
                renderOrderList();
                renderComparisonList();
            })
            .catch(error => {
                console.error("Erreur de chargement des fichiers JSON:", error);
                searchResultsContainer.innerHTML = `<div class="bg-red-50 border-l-4 border-red-400 p-4"><p class="text-sm text-red-700">Erreur : Impossible de charger les données.</p></div>`;
            });

            // --- COMPARE MODE FUNCTIONS ---
            productCodeInput.addEventListener('input', (e) => {
                const code = e.target.value.trim();
                if (!code) {
                    priceComparisonResults.classList.add('hidden');
                    return;
                }
                
                currentProductCode = code;
                findProductByCode(code);
            });
            function findProductByCode(code) {
                const allData = [...dataFolkestone, ...dataVendome, ...dataWashington, ...dataLeHavre];
                const codes = code.includes(' ') ? code.split(' ') : [code];
                
                if (codes.length > 1) {
                    // Traitement des multiples codes
                    priceComparisonCards.innerHTML = '';
                    let hasResults = false;
                    
                    codes.forEach(currentCode => {
                        const products = allData.filter(p => String(p['Code Produit'] ?? '').trim() === currentCode);
                        if (products.length > 0) {
                            hasResults = true;
                            // Créer un groupe pour ce code produit
                            priceComparisonCards.innerHTML += `
                                <div class="col-span-full mb-4">
                                    <h3 class="font-semibold text-lg text-indigo-700 mb-2">${products[0]['Libellé produit'] || 'Produit inconnu'}</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            `;
                            
                            // Afficher les prix pour chaque source
                            ['Folkestone', 'Vendôme', 'Washington', 'Le Havre'].forEach(source => {
                                const product = products.find(p => p._source === source);
                                const price = product ? parsePriceAsFloat(product.Prix) : 0;
                                const priceFormatted = product ? formatPriceFromFloat(price) : '-';
                                
                                priceComparisonCards.innerHTML += `
                                    <div class="price-card">
                                        <div class="price-card-header">${source}</div>
                                        <div class="text-xs text-gray-500 mb-1">${currentCode}</div>
                                        <div class="price-card-value">${priceFormatted}</div>
                                    </div>
                                `;
                            });
                            
                            priceComparisonCards.innerHTML += `</div></div>`;
                        }
                    });
                    
                    if (hasResults) {
                        priceComparisonResults.classList.remove('hidden');
                        addToComparisonListBtn.disabled = false;
                        addToComparisonListBtn.innerHTML = '<i class="fas fa-plus-circle mr-2"></i>Ajouter les résultats à la liste';
                    } else {
                        priceComparisonResults.classList.add('hidden');
                    }
                    return;
                }
                
                // Traitement d'un seul code
                const products = allData.filter(p => String(p['Code Produit'] ?? '').trim() === code);
                if (products.length === 0) {
                    priceComparisonResults.classList.add('hidden');
                    return;
                }
// Group by product name (first product's name)
                const productName = products[0]['Libellé produit'] || 'Produit inconnu';
                const productBrand = products[0]['Marque'] || 'Marque inconnue';
                
                // Store current product details
                currentProductDetails = {
                    code: code,
                    name: productName,
                    brand: productBrand,
                    prices: []
                };
                
                // Clear previous results
                priceComparisonCards.innerHTML = '';
                
                // Check all sources
                const sources = {
                    'Folkestone': dataFolkestone.find(p => p['Code Produit'] == code),
                    'Vendôme': dataVendome.find(p => p['Code Produit'] == code),
                    'Washington': dataWashington.find(p => p['Code Produit'] == code),
                    'Le Havre': dataLeHavre.find(p => p['Code Produit'] == code)
                };
                
                Object.entries(sources).forEach(([source, product]) => {
                    if (product) {
                        const price = parsePriceAsFloat(product.Prix);
                        const priceFormatted = formatPriceFromFloat(price);
                        
                        currentProductDetails.prices.push({
                            source: source,
                            price: price,
                            priceFormatted: priceFormatted
                        });
                        
                        priceComparisonCards.innerHTML += `
                            <div class="price-card">
                                <div class="price-card-header">${source}</div>
                                <div class="price-card-value">${priceFormatted}</div>
                            </div>
                        `;
                    }
                });
                
                priceComparisonResults.classList.remove('hidden');
                updateAddToComparisonButton();
            }

            function updateAddToComparisonButton() {
                if (!currentProductCode || !currentProductDetails) {
                    addToComparisonListBtn.disabled = true;
                    return;
                }
                
                // Check if product is already in comparison list
                const isAlreadyInList = comparisonListData.some(item => item.code === currentProductCode);
                addToComparisonListBtn.disabled = isAlreadyInList;
                
                if (isAlreadyInList) {
                    addToComparisonListBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Déjà dans la liste';
                } else {
                    addToComparisonListBtn.innerHTML = '<i class="fas fa-plus-circle mr-2"></i>Ajouter à la liste de comparaison';
                }
            }

            addToComparisonListBtn.addEventListener('click', () => {
                if (!currentProductCode || !currentProductDetails) return;
                
                comparisonListData.push({
                    code: currentProductCode,
                    name: currentProductDetails.name,
                    brand: currentProductDetails.brand,
                    prices: currentProductDetails.prices
                });
                
                saveComparisonToLocalStorage();
                renderComparisonList();
                updateAddToComparisonButton();
                showNotification('Produit ajouté à la liste de comparaison', 'success');
            });

            function renderComparisonList() {
                if (comparisonListData.length === 0) {
                    comparisonListSection.classList.add('hidden');
                    comparisonList.innerHTML = '<p class="text-center text-gray-500 py-8 px-4">Aucun article ajouté à la liste de comparaison.</p>';
                    return;
                }
                
                comparisonListSection.classList.remove('hidden');
                comparisonCount.textContent = comparisonListData.length;
                
                let tableHTML = `
                    <div class="custom-scrollbar" style="max-height: 400px; overflow-y: auto;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Produit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Marque</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Folkestone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Vendôme</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Washington</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Le Havre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                comparisonListData.forEach((item, index) => {
                    const folkestonePrice = item.prices.find(p => p.source === 'Folkestone')?.priceFormatted || '-';
                    const vendomePrice = item.prices.find(p => p.source === 'Vendôme')?.priceFormatted || '-';
                    const washingtonPrice = item.prices.find(p => p.source === 'Washington')?.priceFormatted || '-';
                    const lehavrePrice = item.prices.find(p => p.source === 'Le Havre')?.priceFormatted || '-';
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.code}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${item.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.brand}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${folkestonePrice}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${vendomePrice}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${washingtonPrice}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lehavrePrice}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-red-500 hover:text-red-700 remove-comparison-item" data-index="${index}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                comparisonList.innerHTML = tableHTML;
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-comparison-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('button').dataset.index);
                        comparisonListData.splice(index, 1);
                        saveComparisonToLocalStorage();
                        renderComparisonList();
                        showNotification('Produit retiré de la liste de comparaison', 'info');
                    });
                });
            }

            // --- EXPORT COMPARISON FUNCTIONS ---
            exportComparisonCsvBtn.addEventListener('click', exportComparisonAsCSV);
            exportComparisonXlsxBtn.addEventListener('click', exportComparisonAsXLSX);

            function exportComparisonAsCSV() {
                if (comparisonListData.length === 0) {
                    showNotification('Aucun produit à exporter', 'warning');
                    return;
                }
                
                const headers = ['Code', 'Produit', 'Marque', 'Folkestone', 'Vendôme', 'Washington', 'Le Havre'];
                const csvContent = [
                    headers.join(';'),
                    ...comparisonListData.map(item => {
                        const folkestonePrice = item.prices.find(p => p.source === 'Folkestone')?.price || '';
                        const vendomePrice = item.prices.find(p => p.source === 'Vendôme')?.price || '';
                        const washingtonPrice = item.prices.find(p => p.source === 'Washington')?.price || '';
                        const lehavrePrice = item.prices.find(p => p.source === 'Le Havre')?.price || '';
                        
                        return [
                            item.code,
                            `"${item.name}"`,
                            `"${item.brand}"`,
                            folkestonePrice,
                            vendomePrice,
                            washingtonPrice,
                            lehavrePrice
                        ].join(';');
                    })
                ].join('\n');
                
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `comparaison_mercuriales_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);
            }

            function exportComparisonAsXLSX() {
                if (comparisonListData.length === 0) {
                    showNotification('Aucun produit à exporter', 'warning');
                    return;
                }
                
                const headers = ['Code', 'Produit', 'Marque', 'Folkestone', 'Vendôme', 'Washington', 'Le Havre'];
                const wsData = [
                    headers,
                    ...comparisonListData.map(item => {
                        const folkestonePrice = item.prices.find(p => p.source === 'Folkestone')?.price || null;
                        const vendomePrice = item.prices.find(p => p.source === 'Vendôme')?.price || null;
                        const washingtonPrice = item.prices.find(p => p.source === 'Washington')?.price || null;
                        const lehavrePrice = item.prices.find(p => p.source === 'Le Havre')?.price || null;
                        
                        return [
                            item.code,
                            item.name,
                            item.brand,
                            folkestonePrice,
                            vendomePrice,
                            washingtonPrice,
                            lehavrePrice
                        ];
                    })
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Mise en forme des colonnes de prix
                const currencyFormat = '#,##0.00" €"';
                for(let i = 1; i < wsData.length; i++) {
                    for(let j = 3; j < 7; j++) {
                        if (wsData[i][j] !== null) {
                            const cellAddress = XLSX.utils.encode_cell({r: i, c: j});
                            if(ws[cellAddress]) ws[cellAddress].z = currencyFormat;
                        }
                    }
                }
                
                ws['!cols'] = [
                    { wch: 10 },  // Code
                    { wch: 40 },  // Produit
                    { wch: 20 },  // Marque
                    { wch: 12 },  // Folkestone
                    { wch: 12 },  // Vendôme
                    { wch: 12 },  // Washington
                    { wch: 12 }   // Le Havre
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Comparaison");
                XLSX.writeFile(wb, `comparaison_mercuriales_${new Date().toISOString().slice(0,10)}.xlsx`);
            }

            // --- ORDER MODE FUNCTIONS (existing functions) ---
            function populateColumnSelector() {
                columnCheckboxesContainer.innerHTML = '';
                allHeaders.forEach(header => {
                    const isChecked = visibleColumns.includes(header);
                    const checkboxHTML = `
                        <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded-md cursor-pointer">
                            <input type="checkbox" value="${header}" ${isChecked ? 'checked' : ''}
                                   class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 column-checkbox">
                            <span class="text-sm text-gray-700">${header}</span>
                        </label>`;
                    columnCheckboxesContainer.insertAdjacentHTML('beforeend', checkboxHTML);
                });
                
                document.querySelectorAll('.column-checkbox').forEach(cb => cb.addEventListener('change', handleColumnSelectionChange));
            }
            
            function handleColumnSelectionChange(e) {
                const { value, checked } = e.target;
                if (checked) {
                    visibleColumns.push(value);
                } else {
                    visibleColumns = visibleColumns.filter(col => col !== value);
                }
                saveColumnsToLocalStorage();
                displaySearchResults(lastSearchResults, searchInput.value.trim().toLowerCase());
                renderOrderList();
            }
            function performSearch() {
                const query = searchInput.value.trim();
                const field = searchField.value;

                if (query.length === 0) {
                    lastSearchResults = [];
                    displaySearchResults([], "");
                    return;
                }

                // Recherche multi-codes avec ESPACE comme séparateur
                if (field === 'Code Produit' && query.includes(' ')) {
                    const codes = query.split(' ').filter(code => code.trim().length > 0);
                    lastSearchResults = [];
                    
                    // Pour chaque code, trouver tous les produits correspondants dans chaque source
                    codes.forEach(code => {
                        currentData.forEach(item => {
                            const itemCode = String(item['Code Produit'] ?? '').trim();
                            if (itemCode === code) {
                                lastSearchResults.push(item);
                            }
                        });
                    });
                } else {
const lowerCaseQuery = query.toLowerCase();
                    lastSearchResults = currentData.filter(item => {
                        if (field === "all") return Object.values(item).some(val => String(val).toLowerCase().includes(lowerCaseQuery));
                        return (item[field]?.toString().toLowerCase() || '').includes(lowerCaseQuery);
                    });
                }
                displaySearchResults(lastSearchResults, query);
            }
function displaySearchResults(results, query) {
                if (results.length === 0) {
                    if (query.length > 0) {
                        let message = `Aucun résultat pour "<strong>${query}</strong>"`;
                        
                        // Message spécifique pour la recherche multi-codes
                        if (searchField.value === 'Code Produit' && isMultiCodeSearch(query)) {
                            const codes = extractProductCodes(query);
                            message = `Aucun résultat pour les codes : <strong>${codes.join(', ')}</strong>`;
                        }
                        
                        searchResultsContainer.innerHTML = `<div class="text-center py-8 px-4"><p class="text-gray-500">${message}</p></div>`;
                    } else {
                        updatePlaceholder();
                    }
                    return;
                }
                // Afficher un indicateur pour la recherche multi-codes
                let infoHTML = '';
                if (searchField.value === 'Code Produit' && query.includes(' ')) {
                    const codes = query.split(' ').filter(code => code.trim().length > 0);
                    const foundCount = results.length;
                    const totalCodes = codes.length;
                    
                    infoHTML = `
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <div class="flex items-center mb-2 sm:mb-0">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            Recherche multi-codes : ${foundCount}/${totalCodes} codes trouvés
                                        </p>
                                    </div>
                                </div>
                                <button id="addAllResultsBtn" class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center justify-center hover:scale-105 transition-transform">
                                    <i class="fas fa-cart-plus mr-2"></i>Ajouter tout à la commande
                                </button>
                            </div>
                        </div>
                    `;
                }
searchResultsContainer.innerHTML = infoHTML + createTableHTML(results, 'search', query);
                
                // Ajouter l'événement pour le bouton "Ajouter tout"
                const addAllBtn = document.getElementById('addAllResultsBtn');
                if (addAllBtn) {
                    addAllBtn.addEventListener('click', () => {
                        addAllSearchResultsToOrder(results);
                    });
                }
            }

            function addAllSearchResultsToOrder(results) {
                if (!results || results.length === 0) {
                    showNotification('Aucun article à ajouter', 'warning');
                    return;
                }
                
                let addedCount = 0;
                let skippedCount = 0;
                
                results.forEach(product => {
                    const isAlreadyInOrder = orderList.some(p => 
                        p["Code Produit"] == product["Code Produit"] && p._source === product._source
                    );
                    
                    if (!isAlreadyInOrder) {
                        orderList.push({
                            ...product,
                            _quantity: 1
                        });
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                });
                
                saveOrderToLocalStorage();
                renderOrderList();
                
                // Notification détaillée
                let message = `${addedCount} article(s) ajouté(s) à la commande`;
                if (skippedCount > 0) {
                    message += `, ${skippedCount} article(s) déjà présent(s)`;
                }
                
                showNotification(message, addedCount > 0 ? 'success' : 'info');
            }
            
            function createTableHTML(data, type, query = '') {
                const isOrder = type === 'order';
                const isMultiCode = type === 'search' && searchField.value === 'Code Produit' && query.includes(' ');
                const codesToHighlight = isMultiCode ? query.split(' ').filter(code => code.trim().length > 0) : [];
return `
                    <div class="custom-scrollbar" style="max-height: 400px; overflow-y: auto;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">Source</th>
                                    ${visibleColumns.map(header => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">${header}</th>`).join('')}
                                    ${isOrder ? '<th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">Quantité</th>' : ''}
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${data.map(item => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getSourceColor(item._source)}">
                                                ${item._source}
                                            </span>
                                        </td>
                                        ${visibleColumns.map(header => {
                                            let cellContent = item[header] ?? '';
                                            
                                            // Appliquer le surlignage approprié
                                            if (isMultiCode) {
                                                cellContent = highlightMultiCodes(cellContent, codesToHighlight);
                                            } else if (query && header === searchField.value) {
                                                cellContent = highlightText(cellContent, query);
                                            }
                                            
                                            // Formatage spécial pour les prix
                                            if (header === 'Prix') {
                                                cellContent = formatPriceFromFloat(parsePriceAsFloat(item[header]));
                                            }
                                            
                                            return `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cellContent}</td>`;
                                        }).join('')}
                                        ${isOrder ? `
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <input type="number" min="0" value="${item._quantity || 1}" class="w-20 px-2 py-1 border border-gray-300 rounded-md text-sm quantity-input"
                                                       data-code="${item['Code Produit']}" data-source="${item._source}">
                                            </td>
                                        ` : ''}
                                        <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                                            ${getActionButtonHTML(item, type)}
                                        </td>
                                    </tr>
                                    ${!isOrder ? `<tr><td colspan="${visibleColumns.length + 2}" class="p-0">${showPriceComparison(item["Code Produit"])}</td></tr>` : ''}
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }

            function renderOrderList() {
                orderCountElement.textContent = orderList.length;
                if (orderList.length === 0) {
                    orderListContainer.innerHTML = `<p class="text-center text-gray-500 py-8 px-4">Aucun article ajouté.</p>`;
                    downloadCsvBtn.disabled = true;
                    downloadXlsxBtn.disabled = true;
                } else {
                    orderListContainer.innerHTML = createTableHTML(orderList, 'order');
                    downloadCsvBtn.disabled = false;
                    downloadXlsxBtn.disabled = false;
                }
                updateOrderTotal();
            }

            // --- FONCTIONS UTILITAIRES ---
            function updateCurrentData() {
                const selectedSources = Array.from(sourceCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
                currentData = [];
                if (selectedSources.includes('folkestone')) currentData.push(...dataFolkestone);
                if (selectedSources.includes('vendome')) currentData.push(...dataVendome);
                if (selectedSources.includes('washington')) currentData.push(...dataWashington);
                if (selectedSources.includes('lehavre')) currentData.push(...dataLeHavre);
            }
            
            function addProductToOrder(code, source) {
                if (orderList.some(p => p["Code Produit"] == code && p._source === source)) {
                    showNotification(`Cet article est déjà dans la commande.`, 'warning'); return;
                }
                const allData = [...dataFolkestone, ...dataVendome, ...dataWashington, ...dataLeHavre];
                const product = allData.find(p => p["Code Produit"] == code && p._source === source);
                if (product) {
                    orderList.push({...product, _quantity: 1});
                    saveOrderToLocalStorage();
                    renderOrderList();
                    showNotification('Article ajouté', 'success');
                }
            }

            function removeProductFromOrder(code, source) {
                orderList = orderList.filter(p => !(p["Code Produit"] == code && p._source === source));
                saveOrderToLocalStorage();
                renderOrderList();
                showNotification('Article retiré', 'info');
            }
            
            function showPriceComparison(productCode) {
                if (!productCode) return '';
                const allProducts = [...dataFolkestone, ...dataVendome, ...dataWashington, ...dataLeHavre];
                const sameProducts = allProducts.filter(p => p["Code Produit"] == productCode);
                
                if (sameProducts.length <= 1) return '';

                return `
                    <div class="m-2 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                        <h4 class="text-sm font-semibold text-indigo-800 mb-2 flex items-center">
                            <i class="fas fa-chart-line mr-2"></i>Comparaison des prix
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                            ${sameProducts.map(product => `
                                <div class="text-center p-2 bg-white rounded border">
                                    <div class="font-medium ${getSourceColor(product._source).replace('bg-', 'text-').split(' ')[0]}">${product._source}</div>
                                    <div class="text-gray-800 font-bold mt-1">${formatPriceFromFloat(parsePriceAsFloat(product.Prix))}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }

            function updateProductQuantity(code, source, newQuantity) {
                const productIndex = orderList.findIndex(p => p["Code Produit"] == code && p._source === source);
                if (productIndex !== -1) {
                    const quantity = parseInt(newQuantity);
                    if (isNaN(quantity) || quantity <= 0) {
                        orderList.splice(productIndex, 1);
                    } else {
                        orderList[productIndex]._quantity = quantity;
                    }
                    saveOrderToLocalStorage();
                    renderOrderList();
                }
            }

            function updateOrderTotal() {
                let totalElement = document.getElementById('orderTotal');
                if (orderList.length === 0) {
                    totalElement?.remove();
                    return;
                }
                
                // Calcul en centimes pour la précision
                const totalInCents = orderList.reduce((sum, p) => {
                    const priceInCents = parsePriceAsCents(p.Prix);
                    const quantity = p._quantity || 1;
                    return sum + (priceInCents * quantity);
                }, 0);
                
                if (!totalElement) {
                    totalElement = document.createElement('div');
                    totalElement.id = 'orderTotal';
                    totalElement.className = 'mt-4 p-4 bg-green-50 border-l-4 border-green-400';
                    orderListContainer.parentNode.insertBefore(totalElement, orderListContainer.nextSibling);
                }
                totalElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-green-800 text-lg">Total de la commande :</span>
                        <span class="text-2xl font-bold text-green-700">${formatPriceFromCents(totalInCents)}</span>
                    </div>`;
            }
            
            // --- FONCTIONS DE GESTION DES PRIX ---
            function parsePriceAsFloat(priceStr) {
                if (typeof priceStr !== 'string') priceStr = String(priceStr);
                return parseFloat(priceStr.replace(',', '.')) || 0;
            }

            function parsePriceAsCents(priceStr) {
                const priceFloat = parsePriceAsFloat(priceStr);
                return Math.round(priceFloat * 100);
            }

            function formatPriceFromFloat(priceFloat) {
                return (priceFloat || 0).toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
            }
            
            function formatPriceFromCents(priceInCents) {
                return formatPriceFromFloat((priceInCents || 0) / 100);
            }
            
            function initializeModals() {
                settingsBtn.addEventListener('click', (e) => { e.preventDefault(); settingsModal.classList.remove('hidden'); });
                contactBtn.addEventListener('click', (e) => { e.preventDefault(); contactModal.classList.remove('hidden'); });
                
                closeModalBtns.forEach(btn => btn.addEventListener('click', () => {
                    settingsModal.classList.add('hidden');
                    contactModal.classList.add('hidden');
                }));

                resetAppBtn.addEventListener('click', () => {
                    if (confirm("Êtes-vous sûr de vouloir tout réinitialiser ? Votre commande et vos préférences de colonnes seront perdues.")) {
                        localStorage.removeItem('mercurialeOrder');
                        localStorage.removeItem('mercurialeColumns');
                        localStorage.removeItem('mercurialeComparison');
                        location.reload();
                    }
                });
            }

            // --- FONCTIONS D'EXPORT ---
            function downloadOrderAsCSV() {
                const headers = ['Source', ...visibleColumns, 'Quantité', 'Total'];
                const csvContent = [
                    headers.join(';'),
                    ...orderList.map(row => {
                        const total = (parsePriceAsFloat(row.Prix) * (row._quantity || 1)).toFixed(2).replace('.', ',');
                        const values = [
                            row._source, 
                            ...visibleColumns.map(h => row[h] ?? ''),
                            row._quantity || 1,
                            total
                        ];
                        return values.map(v => `"${String(v).replace(/"/g, '""')}"`).join(';');
                    })
                ].join('\n');
                
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `commande_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);
            }

            function downloadOrderAsXLSX() {
                const headers = ['Source', ...visibleColumns, 'Quantité', 'Total'];
                const wsData = [
                    headers, 
                    ...orderList.map(row => {
                        const price = parsePriceAsFloat(row.Prix);
                        const quantity = row._quantity || 1;
                        return [
                            row._source, 
                            ...visibleColumns.map(h => (h === 'Prix') ? price : (row[h] ?? '')),
                            quantity,
                            price * quantity
                        ];
                    })
                ];
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Mise en forme des colonnes
                const priceColIndex = visibleColumns.indexOf('Prix') + 1; // +1 pour la colonne "Source"
                const totalColIndex = headers.length - 1;
                const currencyFormat = '#,##0.00" €"';

                for(let i = 1; i < wsData.length; i++) { // Boucle sur les lignes de données
                    const priceCellAddress = XLSX.utils.encode_cell({r: i, c: priceColIndex});
                    const totalCellAddress = XLSX.utils.encode_cell({r: i, c: totalColIndex});
                    if(ws[priceCellAddress]) ws[priceCellAddress].z = currencyFormat;
                    if(ws[totalCellAddress]) ws[totalCellAddress].z = currencyFormat;
                }
                
                ws['!cols'] = headers.map(h => ({ wch: (h === 'Libellé produit') ? 40 : 15 }));

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Commande");
                XLSX.writeFile(wb, `commande_${new Date().toISOString().slice(0,10)}.xlsx`);
            }

            // --- FONCTIONS AUXILIAIRES ---
            function getActionButtonHTML(item, type) {
                const dataAttrs = `data-code="${item["Code Produit"]}" data-source="${item._source}"`;
                const isInOrder = orderList.some(p => p["Code Produit"] == item["Code Produit"] && p._source === item._source);
                
                if (type === 'search') {
                    if (isInOrder) {
                        return `
                            <div class="flex flex-col items-center space-y-1">
                                <button class="bg-green-500 text-white px-3 py-1 rounded-md text-xs flex items-center cursor-not-allowed" disabled>
                                    <i class="fas fa-check mr-1"></i>Déjà ajouté
                                </button>
                                <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs flex items-center btn-remove-from-search" ${dataAttrs}>
                                    <i class="fas fa-minus mr-1"></i>Retirer
                                </button>
                            </div>`;
                    } else {
                        return `<button class="btn-primary text-white px-3 py-1 rounded-md text-xs flex items-center btn-add" ${dataAttrs}><i class="fas fa-plus mr-1"></i>Ajouter</button>`;
                    }
                }
                return `<button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-xs flex items-center btn-remove" ${dataAttrs}><i class="fas fa-trash-alt mr-1"></i>Supprimer</button>`;
            }

            function getSourceColor(source) {
                switch(source) {
                    case 'Folkestone': return 'bg-blue-100 text-blue-800';
                    case 'Vendôme': return 'bg-purple-100 text-purple-800';
                    case 'Washington': return 'bg-green-100 text-green-800';
                    case 'Le Havre': return 'bg-orange-100 text-orange-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            function updateProductCount() {
                productCountElement.textContent = `${currentData.length} produits`;
            }
            function highlightText(text, query) {
                const content = text ?? '';
                if (!query || !content) return content;
                
                // Ne pas surligner si c'est une recherche multi-codes
                if (searchField.value === 'Code Produit' && query.includes(' ')) {
                    return content;
                }
return String(content).replace(
                    new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'), 
                    '<span class="search-highlight">$1</span>'
                );
            }
            
            function updatePlaceholder() {
                searchResultsContainer.innerHTML = `<div class="text-center py-8 px-4"><p class="text-gray-500">Commencez à taper pour rechercher...</p></div>`;
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                const icons = {'success': 'fa-check-circle', 'error': 'fa-exclamation-circle', 'warning': 'fa-exclamation-triangle', 'info': 'fa-info-circle'};
                const colors = {'success': 'bg-green-500', 'error': 'bg-red-500', 'warning': 'bg-yellow-500', 'info': 'bg-blue-500'};
                notification.className = `fixed bottom-4 right-4 text-white px-4 py-3 rounded-md shadow-lg flex items-center z-50 transition-all duration-300 transform translate-y-16 opacity-0 ${colors[type] || colors['info']}`;
                notification.innerHTML = `<i class="fas ${icons[type] || icons['info']} mr-2"></i><span>${message}</span>`;
                document.body.appendChild(notification);
                setTimeout(() => { notification.classList.remove('translate-y-16', 'opacity-0'); }, 10);
                setTimeout(() => { notification.classList.add('opacity-0', 'translate-y-4'); setTimeout(() => notification.remove(), 300); }, 3000);
            }
        });
    </script>
</body>
</html>
